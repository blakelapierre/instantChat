{"version":3,"file":"src/admin.js","sources":["src/admin.js","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourceRoot":"/home/blake/development/instantChat/admin","sourcesContent":["var fs = require('fs'),\n    path = require('path'),\n    glob = require('glob'),\n    request = require('request'),\n    traceur = require('traceur-runtime');\n\nvar doWrapper = require('do-wrapper');\n\nvar doProvider = require('./providers/digitalocean')({token: process.env.DO_TOKEN});\nvar dummyProvider = require('./providers/dummy')();\n\nvar provider = doProvider;\n// var provider = dummyProvider;\n\nvar launcher = require('./launcher')(provider, (...args) => console.log(new Date(), ...args));\n\nvar hogan = require('hogan.js');\nvar uuid = require('node-uuid');\nvar _ = require('lodash');\n\n\nvar keys = ['40:85:f0:9b:28:ad:5d:25:b5:51:2e:ad:f3:b3:31:98'];\n\nvar baseDir = path.join(__dirname, '..');\n\nvar cloud_config = fs.readFileSync(path.join(baseDir, 'cloud-config')).toString();\nvar bootstrapTemplate = fs.readFileSync(path.join(baseDir, 'bootstrap.sh.template')).toString();\n\ncloud_config = hogan.compile(cloud_config);\nbootstrapTemplate = hogan.compile(bootstrapTemplate);\n\nvar service_files = glob.sync('../services/**/*.service');\n\nvar services = _.reduce(service_files, (result, fileName) => {\n  var name = fileName.substring(fileName.lastIndexOf('/') + 1, fileName.lastIndexOf('.service'));\n\n  result[name] = {\n    name: name,\n    command: 'start',\n    content: fs.readFileSync(fileName).toString()\n  };\n\n  return result;\n}, {});\n\nvar log = (...args) => console.log(...args);\n\n// launchCluster(doProvider);\nlaunchCluster(provider, log)\n  .then(machines => console.log('launched', machines.length, 'machines'),\n        error => console.log('error', error));\n\nfunction launchCluster(provider, log) {\n  return new Promise((resolve, reject) => {\n    request('https://discovery.etcd.io/new', (error, response, discovery_url) => {\n      if (error) {\n        console.log('Error getting discovery url!');\n        return false;\n      }\n\n      log('seed', discovery_url);\n\n      var create = (count, role) => {\n        var location = 'sfo1',\n            size = '512mb',\n            image = 'coreos-alpha',\n            then = () => {};\n\n        var launch = () => {\n          return _.map(_.range(count), i => {\n\n            var id = uuid.v4();\n\n            var machine = {\n              provider: provider.name,\n              location,\n              role,\n              image,\n              size,\n              id\n            };\n\n            var metadata = _.map(machine, (value, key) => key + '=' + value).join(',');\n\n            var files = getFiles(machine);\n\n            var userData = cloud_config.render({discovery_url, metadata, files});\n\n            return {\n              id,\n              provider: provider.name,\n              location,\n              size,\n              image,\n              keys,\n              userData\n            };\n          });\n        };\n\n        // This will cause launch to fire at the end of the chain\n        //setImmediate(launch);\n\n        var chain = (() => {\n          return fn => {\n            fn();\n            return chain;\n          };\n        })();\n\n        chain.at = l => chain(() => location = l);\n        chain.size = s => chain(() => size = s);\n        chain.then = t => chain(() => then = t);\n        chain.launch = launch;\n\n        return chain;\n      };\n\n      var machines = _.flatten([\n        create(1, 'influxdb').at('sfo1').launch(),\n        create(1, 'grafana').at('sfo1').launch(),\n        create(1, 'benchmarker').at('sfo1').launch(),\n        create(7, 'broadcaster').at('sfo1').launch()\n      ]);\n\n      // how do we generate the machines on demand instead of all up front?\n      launcher.launch(machines).then(machines => {\n        console.log('All machines launched!');\n        fs.writeFileSync(path.join(baseDir, 'cloud.machines'), JSON.stringify(machines));\n        resolve(machines);\n      }, error => reject(error))\n      .catch(error => reject(error));\n    });\n  });\n}\n\nvar roleServices = {\n  'core': [\n    'cadvisor'\n  ],\n  'influxdb': [\n    'cadvisor',\n    'influxdb'\n  ],\n  'grafana': [\n    'cadvisor',\n    'grafana'\n  ],\n  'broadcaster': [\n    'cadvisor',\n    'broadcaster@'\n  ],\n  'benchmarker': [\n    'cadvisor',\n    'benchmarker'\n  ]\n};\n\nfunction getFiles(machine) {\n  var {id, role} = machine;\n\n  var services = roleServices[role];\n\n  var bootstrap = {\n    path: '/home/core/bootstrap.sh',\n    owner: 'core',\n    permissions: '0700',\n    content: indent(bootstrapTemplate.render({services: _.map(services, serviceName => {return {fileName: serviceName + '.service', name: serviceName + (serviceName.indexOf('@') >= 0 ? id : '')};})}), '      ')\n  };\n\n  return [bootstrap].concat(_.map(services, makeFileRecord));\n}\n\nfunction makeFileRecord(serviceName) {\n  var service = services[serviceName];\n\n  if (!service) {\n    console.log(serviceName, 'not found!');\n  }\n\n  return {\n    path: '/home/core/' + serviceName + '.service',\n    owner: 'core',\n    permissions: '0600',\n    content: indent(service.content, '      ')\n  };\n}\n\nfunction indent(s, i) {\n  return s.replace(/^/gm, i);\n}\n\n// function chainable(launch, methods) {\n\n//   setImmediate(launch);\n\n//   for (var name in methods) {\n//     chain[name] = (args...) => chain(methods[name]);\n//   }\n\n//   return chain;\n\n//   function chain(fn) {\n//     fn();\n//     return chain;\n//   }\n// }","\n            for (var $__placeholder__0 = [], $__placeholder__1 = 0;\n                 $__placeholder__2 < arguments.length; $__placeholder__3++)\n              $__placeholder__4[$__placeholder__5] = arguments[$__placeholder__6];","$traceurRuntime.spread($__placeholder__0)"]}